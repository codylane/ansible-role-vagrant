---
# This task helps you create a new base box from an existing box.

- name: Creating temporary directories
  tags: repackage
  file:
    path="/tmp/{{ item }}"
    state=directory
    mode=0755
  with_items:
    - "{{ repackage_boxes }}"

- name: Checking if Vagrantfile already exists
  tags: repackage
  stat:
    path="/tmp/{{ item }}/Vagrantfile"
  register: vagrantfile_exists
  with_items:
    - "{{ repackage_boxes }}"

- name: Creating temporary Vagrantfile
  tags: repackage
  template:
    src=vagrantfile-repackage.j2
    dest="/tmp/{{ item.0 }}/Vagrantfile"
  when:
    item.1.stat.exists == False
  with_nested:
    - "{{ repackage_boxes }}"
    - "{{ vagrantfile_exists.results }}"

- name: Brining up vagrant machine
  tags: repackage
  shell: vagrant up
  args:
    chdir: "/tmp/{{ item }}"
  with_items:
    - "{{ repackage_boxes }}"

- name: Getting ip address of your box
  tags: repackage
  shell: vagrant ssh-config | egrep '(HostName |User |Port |IdentityFile )' | sed -e 's/^  *//g' -e 's/HostName //g' -e 's/User //g' -e 's/Port //g' -e 's/IdentityFile //g'
  args:
    chdir: "/tmp/{{ item }}"
  register: vagrant_ssh_config
  with_items:
    - "{{ repackage_boxes }}"

- name: Creating temporary inventory file
  tags: repackage
  template:
   src=temp-inventory.j2
   dest=/tmp/inventory
  with_items:
    - "{{ vagrant_ssh_config }}"
